# Line Provider Service

## –û–ø–∏—Å–∞–Ω–∏–µ
Line Provider Service - —ç—Ç–æ —Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è–º–∏ –∏ —Å—Ç–∞–≤–∫–∞–º–∏, —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º FastAPI –∏ Redis. –°–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π, —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏—Ö —Å—Ç–∞—Ç—É—Å–∞–º–∏ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ callback-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- üöÄ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
- üì¶ Redis –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å TTL
- üîÑ –°–∏—Å—Ç–µ–º–∞ callback-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- üìù –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è OpenAPI –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- üß™ –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ
- üê≥ Docker –∏ Docker Compose –ø–æ–¥–¥–µ—Ä–∂–∫–∞

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Python 3.10+
- Redis 6+
- Docker –∏ Docker Compose (–¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏–∏)

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```
line_provider/
‚îÇ
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ main.py              # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ api/                 # API endpoints
‚îÇ   ‚îú‚îÄ‚îÄ core/                # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –±–∞–∑–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ models/              # Pydantic –º–æ–¥–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ schemas/             # –°—Ö–µ–º—ã –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—Ç–≤–µ—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ services/            # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îî‚îÄ‚îÄ storage/             # –†–∞–±–æ—Ç–∞ —Å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º
‚îÇ
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ conftest.py           # –û–±—â–∏–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ test_events.py        # –¢–µ—Å—Ç—ã –¥–ª—è —Å–æ–±—ã—Ç–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ test_callbacks.py     # –¢–µ—Å—Ç—ã –¥–ª—è callbacks
‚îÇ   ‚îî‚îÄ‚îÄ test_service.py       # –¢–µ—Å—Ç—ã –¥–ª—è C–µ—Ä–≤–∏—Å–æ–≤
‚îÇ
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ docker-compose.yml
‚îî‚îÄ‚îÄ pyproject.toml
```

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
```bash
# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
git clone https://github.com/Mobiss11/line-provider
cd line-provider

# –°–æ–∑–¥–∞–Ω–∏–µ –∏ –∞–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
python3.10 -m venv venv
source venv/bin/activate

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
pip install pip --upgrade
pip install setuptools --upgrade
pip install poetry

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞
poetry install
```

### –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker
```bash
# –°–±–æ—Ä–∫–∞
docker build -t line-provider:latest .

# –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
docker-compose up --build

# –¢–æ–ª—å–∫–æ –∑–∞–ø—É—Å–∫ (–µ—Å–ª–∏ –æ–±—Ä–∞–∑ —É–∂–µ —Å–æ–±—Ä–∞–Ω)
docker-compose up -d

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
docker-compose down
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ —Ñ–∞–π–ª `.env`:

```env
APP_NAME=Line Provider Service
DEBUG=True
REDIS_URL=redis://127.0.0.1:6378/0
EVENT_EXTRA_TTL=604800
CALLBACK_TTL=86400
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤
```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Redis –∑–∞–ø—É—â–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–æ–≤
docker run -d -p 6379:6379 --name redis-test redis:6

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ docker-compose
docker-compose up -d redis
```

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
poetry run pytest

# –ó–∞–ø—É—Å–∫ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
poetry run pytest -v

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
poetry run pytest --cov=app tests/

# –ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≥—Ä—É–ø–ø—ã —Ç–µ—Å—Ç–æ–≤
poetry run pytest tests/test_events.py

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –º–µ—Ç–∫–∞–º–∏
poetry run pytest -m "slow"  # –º–µ–¥–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
poetry run pytest -m "integration"  # –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

# –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
poetry run pytest -n auto  # –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ CPU —è–¥—Ä–∞
```

### –¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ
```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML-–æ—Ç—á–µ—Ç–∞ –æ –ø–æ–∫—Ä—ã—Ç–∏–∏
poetry run pytest --cov=app --cov-report=html

# –û—Ç—á–µ—Ç –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ coverage_html/index.html
```

### –û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤
```bash
# –ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥ —Å print-statements
poetry run pytest -v --capture=no

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –ø–∞–¥–µ–Ω–∏—è
poetry run pytest -x

# –í—ã–≤–æ–¥ —Å–∞–º—ã—Ö –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
poetry run pytest --durations=10
```

## Configuration Ruff
```toml
[tool.ruff]
fix = true
unsafe-fixes = true
line-length = 120
select = ["ALL"]
ignore = ["D1", "D203", "D213", "FA102", "ANN101", "UP007", "TCH001", "BLE001", "DTZ005", "TRY300", "DTZ007"]

[tool.ruff.isort]
no-lines-before = ["standard-library", "local-folder"]
known-third-party = []
known-local-folder = ["whole_app"]

[tool.ruff.extend-per-file-ignores]
"./*.py" = ["ANN401", "S101", "S311", "F401"]
```

## API Endpoints

### –°–æ–±—ã—Ç–∏—è (Events)

#### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–æ–±—ã—Ç–∏–π
```http
GET /events
```
–û—Ç–≤–µ—Ç:
```json
{
    "status": "success",
    "message": "–°–æ–±—ã—Ç–∏—è —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã",
    "data": {
        "events": {
            "event1": [{
                "event_id": "event1",
                "coefficient": 1.85,
                "deadline": "2024-03-25T12:00:00",
                "status": "new"
            }]
        }
    }
}
```

#### –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
```http
POST /events
```
–ó–∞–ø—Ä–æ—Å:
```json
{
    "event_id": "event1",
    "coefficient": 1.85,
    "deadline": "2024-10-29T15:00:00",
    "status": "new"
}
```

#### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–±—ã—Ç–∏—è
```http
PUT /events/{event_id}/status
```
–ó–∞–ø—Ä–æ—Å:
```json
{
    "status": "first_team_won"
}
```

### Callbacks

#### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è callback
```http
POST /callbacks/register
```
–ó–∞–ø—Ä–æ—Å:
```json
{
    "url": "http://example.com/webhook"
}
```

## CI/CD
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ (mypy)
- –õ–∏–Ω—Ç–∏–Ω–≥ (ruff)
- –¢–µ—Å—Ç—ã (pytest)

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### Redis –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ pipeline –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ TTL
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### TTL –ø–æ–ª–µ–∑–µ–Ω –≤ –Ω–∞—à–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –¥–ª—è:

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ –ø–∞–º—è—Ç–∏ - —Å—Ç–∞—Ä—ã–µ —Å–æ–±—ã—Ç–∏—è —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –°–æ–±–ª—é–¥–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª - —Å–æ–±—ã—Ç–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è —Å—Ç–∞–≤–æ–∫ –ø–æ—Å–ª–µ –¥–µ–¥–ª–∞–π–Ω–∞
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–∞–º—è—Ç–∏ - –Ω–µ —Ö—Ä–∞–Ω–∏–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è callbacks - –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ webhooks –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è
- –î–ª—è —Å–æ–±—ã—Ç–∏–π: –≤—Ä–µ–º—è –¥–æ –¥–µ–¥–ª–∞–π–Ω–∞ + –≤—Ä–µ–º—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
- –î–ª—è callbacks: –≤—Ä–µ–º—è –º–µ–∂–¥—É –ø–∏–Ω–≥–∞–º–∏ + –∑–∞–ø–∞—Å

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ä—ã
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ HTTPS
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞
- –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

## FAQ

### –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π endpoint?
1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ñ–∞–π–ª –≤ `app/api/endpoints/`
2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –Ω–æ–≤—ã–π router
3. –î–æ–±–∞–≤—å—Ç–µ router –≤ `app/api/routes.py`
4. –î–æ–±–∞–≤—å—Ç–µ —Ç–µ—Å—Ç—ã

### –ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Å–æ–±—ã—Ç–∏–π?
–ò–∑–º–µ–Ω–∏—Ç–µ `EVENT_EXTRA_TTL` –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ `.env` —Ñ–∞–π–ª–µ.

### –î–∞–ª—å–Ω–µ–π—à–µ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ Redis
2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –Ω–∞–≥—Ä—É–∑–∫–∏
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Redis Cluster –¥–ª—è –±–æ–ª—å—à–∏—Ö –Ω–∞–≥—Ä—É–∑–æ–∫
